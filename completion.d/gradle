# Modified from original completion script at:
# https://gist.github.com/nolanlawson/8694399

_gradle()
{
  local cur=${COMP_WORDS[COMP_CWORD]}

  if [ -f ./gradlew ]; then
    gradle_cmd='./gradlew'
  else
    gradle_cmd='gradle'
  fi

  local commands=''
  local cache_dir="$HOME/.gradle_completion"
  mkdir -p $cache_dir

  local gradle_files_checksum='';

  if [[ -f build.gradle ]]; then # top-level gradle file
    gradle_files_checksum=$(\
        find . -name build.gradle 2> /dev/null \
             | sort -u \
             | xargs cat \
             | git hash-object --stdin\
        )
  else # no top-level gradle file
    gradle_files_checksum='no_gradle_files'
  fi

  if [[ -f $cache_dir/$gradle_files_checksum ]]; then # cached! yay!
    commands=$(cat $cache_dir/$gradle_files_checksum)
  else # not cached! boo-urns!
    commands=$(\
      $gradle_cmd tasks \
        | sed -e 0,/Build/d -e '/Rules/,$d' \
        | awk 'BEGIN {p=0} /^-+/ {p=1} /^$/ {p=0} /^[^-]/ {if (p) print $1}'
    )
  fi

  if [[ ! -z $commands ]]; then
      echo $commands > $cache_dir/$gradle_files_checksum
  fi

  COMPREPLY=( $(compgen -W "$commands" -- $cur) )
}

complete -F _gradle gradle
complete -F _gradle gradlew
complete -F _gradle ./gradlew

# vim:ft=bash.sh:
